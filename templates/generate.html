{% extends "base.html" %}

{% block title %}Generate Content - Content Automation Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-magic me-2"></i>
            {% if edit_content %}Edit Content{% else %}Generate Content{% endif %}
        </h1>
    </div>
</div>

<div class="row">
    <!-- Content Generation Form -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Content Settings
                </h5>
            </div>
            <div class="card-body">
                <form id="contentForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="platform" class="form-label">Platform</label>
                            <select class="form-select" id="platform" name="platform" required>
                                <option value="">Select Platform</option>
                                {% for platform in platforms %}
                                <option value="{{ platform }}" 
                                        {% if edit_content and edit_content.platform == platform %}selected{% endif %}>
                                    {{ platform.title() }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="template" class="form-label">Template</label>
                            <select class="form-select" id="template" name="template">
                                <option value="">Select Template (Optional)</option>
                                {% for template in templates %}
                                <option value="{{ template.template_text }}" data-platform="{{ template.platform }}">
                                    {{ template.name }} ({{ template.platform.title() }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="tone" class="form-label">Tone</label>
                            <select class="form-select" id="tone" name="tone">
                                <option value="professional">Professional</option>
                                <option value="casual">Casual</option>
                                <option value="friendly">Friendly</option>
                                <option value="authoritative">Authoritative</option>
                                <option value="humorous">Humorous</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="length" class="form-label">Length</label>
                            <select class="form-select" id="length" name="length">
                                <option value="short">Short</option>
                                <option value="medium" selected>Medium</option>
                                <option value="long">Long</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="topic" class="form-label">Topic/Subject</label>
                            <input type="text" class="form-control" id="topic" name="topic" 
                                   placeholder="Enter main topic...">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="customTemplate" class="form-label">Custom Template</label>
                        <textarea class="form-control" id="customTemplate" name="customTemplate" rows="4"
                                  placeholder="Enter your custom template or let AI generate based on settings..."></textarea>
                        <div class="form-text">Use placeholders like [TOPIC], [BENEFIT], [CALL_TO_ACTION] for dynamic content</div>
                    </div>
                    
                    {% if not edit_content %}
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                            <i class="fas fa-magic me-2"></i>Generate Content
                        </button>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    
    <!-- Generated Content Preview -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-eye me-2"></i>Preview
                </h5>
            </div>
            <div class="card-body">
                <div id="previewContent">
                    {% if edit_content %}
                        <div class="mb-3">
                            <label for="contentTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="contentTitle" 
                                   value="{{ edit_content.title }}">
                        </div>
                        <div class="mb-3">
                            <label for="contentText" class="form-label">Content</label>
                            <textarea class="form-control" id="contentText" rows="8">{{ edit_content.content }}</textarea>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="saveBtn" data-content-id="{{ edit_content.id }}">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                            <button class="btn btn-secondary" id="scheduleBtn" data-content-id="{{ edit_content.id }}">
                                <i class="fas fa-calendar me-2"></i>Schedule
                            </button>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <p>Generated content will appear here</p>
                        </div>
                    {% endif %}
                </div>
                
                <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating...</span>
                    </div>
                    <p class="mt-2">Generating content...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <div class="mb-3">
                        <label for="scheduleDateTime" class="form-label">Schedule Date & Time</label>
                        <input type="datetime-local" class="form-control" id="scheduleDateTime" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSchedule">Schedule</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateForm = document.getElementById('contentForm');
    const generateBtn = document.getElementById('generateBtn');
    const previewContent = document.getElementById('previewContent');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const templateSelect = document.getElementById('template');
    const platformSelect = document.getElementById('platform');
    const customTemplateTextarea = document.getElementById('customTemplate');
    
    // Template selection handler
    templateSelect.addEventListener('change', function() {
        if (this.value) {
            customTemplateTextarea.value = this.value;
            const selectedOption = this.options[this.selectedIndex];
            const templatePlatform = selectedOption.dataset.platform;
            if (templatePlatform) {
                platformSelect.value = templatePlatform;
            }
        }
    });
    
    // Generate content
    if (generateForm && generateBtn) {
        generateForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            previewContent.style.display = 'none';
            loadingSpinner.style.display = 'block';
            
            const formData = new FormData(this);
            const data = {
                platform: formData.get('platform'),
                template: formData.get('customTemplate') || formData.get('template'),
                topic: formData.get('topic'),
                tone: formData.get('tone'),
                length: formData.get('length')
            };
            
            try {
                const response = await fetch('/api/generate-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayGeneratedContent(result);
                } else {
                    showAlert('Error generating content: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'danger');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Content';
                loadingSpinner.style.display = 'none';
                previewContent.style.display = 'block';
            }
        });
    }
    
    function displayGeneratedContent(result) {
        const html = `
            <div class="mb-3">
                <label for="contentTitle" class="form-label">Title</label>
                <input type="text" class="form-control" id="contentTitle" value="${result.title}">
            </div>
            <div class="mb-3">
                <label for="contentText" class="form-label">Content</label>
                <textarea class="form-control" id="contentText" rows="8">${result.content}</textarea>
            </div>
            ${result.hashtags && result.hashtags.length > 0 ? `
            <div class="mb-3">
                <label class="form-label">Suggested Hashtags</label>
                <div class="hashtags">
                    ${result.hashtags.map(tag => `<span class="badge bg-info me-1">#${tag}</span>`).join('')}
                </div>
            </div>
            ` : ''}
            <div class="d-grid gap-2">
                <button class="btn btn-success" id="saveBtn" data-content-id="${result.content_id}">
                    <i class="fas fa-save me-2"></i>Save Content
                </button>
                <button class="btn btn-secondary" id="scheduleBtn" data-content-id="${result.content_id}">
                    <i class="fas fa-calendar me-2"></i>Schedule
                </button>
            </div>
        `;
        
        previewContent.innerHTML = html;
        setupContentActions();
    }
    
    function setupContentActions() {
        const saveBtn = document.getElementById('saveBtn');
        const scheduleBtn = document.getElementById('scheduleBtn');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', async function() {
                const contentId = this.dataset.contentId;
                const title = document.getElementById('contentTitle').value;
                const content = document.getElementById('contentText').value;
                const platform = document.getElementById('platform').value;
                
                try {
                    const response = await fetch(`/api/update-content/${contentId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ title, content, platform })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showAlert('Content saved successfully!', 'success');
                    } else {
                        showAlert('Error saving content: ' + result.error, 'danger');
                    }
                } catch (error) {
                    showAlert('Network error: ' + error.message, 'danger');
                }
            });
        }
        
        if (scheduleBtn) {
            scheduleBtn.addEventListener('click', function() {
                const contentId = this.dataset.contentId;
                document.getElementById('confirmSchedule').dataset.contentId = contentId;
                new bootstrap.Modal(document.getElementById('scheduleModal')).show();
            });
        }
    }
    
    // Schedule confirmation
    const confirmScheduleBtn = document.getElementById('confirmSchedule');
    if (confirmScheduleBtn) {
        confirmScheduleBtn.addEventListener('click', async function() {
            const contentId = this.dataset.contentId;
            const scheduleDateTime = document.getElementById('scheduleDateTime').value;
            
            if (!scheduleDateTime) {
                showAlert('Please select a date and time', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/schedule-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content_id: contentId,
                        scheduled_time: new Date(scheduleDateTime).toISOString()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Content scheduled successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                } else {
                    showAlert('Error scheduling content: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'danger');
            }
        });
    }
    
    // Setup edit mode actions
    setupContentActions();
});
</script>
{% endblock %}
